@model TourismWeb.Models.TouristSpot
@using Microsoft.AspNetCore.Antiforgery
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@inject IAntiforgery AntiForgery
@Html.AntiForgeryToken()

@{
    ViewData["Title"] = Model.Name;
}

@section Styles {
    <link rel="stylesheet" href="~/css/spotLayout.css" asp-append-version="true" />
}

@{
    var userIdClaim = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
    var userId = userIdClaim != null ? int.Parse(userIdClaim.Value) : 0;
    var isFavorited = Model.Favorites?.Any(f => f.UserId == userId) == true;
}

<div class="breadcrumb container">
    <a asp-controller="Home" asp-action="Index">Trang ch·ªß</a> &gt;
    <a asp-action="Index">ƒê·ªãa ƒëi·ªÉm du l·ªãch</a> &gt;
    <span>@Model.Name</span>
</div>

<!-- Main Content -->
<main class="container">
    <!-- Spot Header -->
    <section class="spot-header">
        <div class="spot-title">
            <h1>@Model.Name</h1>
            <div class="spot-meta">
                <span class="category"><i class="fas fa-tag"></i> @Model.Category.Name</span>
                <span class="rating">
                    @for (int i = 0; i < 5; i++)
                    {
                        if (i < ViewBag.AverageRating)
                        {
                            <i class="fas fa-star"></i> <!-- Sao ƒë·∫ßy -->
                        }
                        else if (i < ViewBag.AverageRating + 0.5)
                        {
                            <i class="fas fa-star-half-alt"></i> <!-- Sao n·ª≠a -->
                        }
                        else
                        {
                            <i class="far fa-star"></i> <!-- Sao r·ªóng -->
                        }
                    }
                    <span>@ViewBag.AverageRating/5</span> (@(Model.Reviews?.Count ?? 0) ƒë√°nh gi√°)
                </span>

            </div>
        </div>
        <div class="spot-actions">
            <!-- N√∫t Y√™u th√≠ch -->
            <button class="btn favorite @(isFavorited ? "active" : "")" id="favoriteBtn" data-spot-id="@Model.SpotId">
                <i class="@(isFavorited ? "fas" : "far") fa-heart"></i> @(isFavorited ? "ƒê√£ y√™u th√≠ch" : "Y√™u th√≠ch")
            </button>
            <div class="share-dropdown">
                <button class="btn share"><i class="fas fa-share-alt"></i> Chia s·∫ª</button>
                <div class="share-options">
                    <a href="#" class="share-btn" data-platform="Facebook" data-spot-id="@Model.SpotId">
                        <i class="fab fa-facebook-f"></i> Facebook
                    </a>
                    <a href="#" class="share-btn" data-platform="Twitter" data-spot-id="@Model.SpotId">
                        <i class="fab fa-twitter"></i> Twitter
                    </a>
                    @* <a href="#" class="share-btn" data-platform="Instagram" data-spot-id="@Model.SpotId">
                        <i class="fab fa-instagram"></i> Instagram
                    </a> *@
                    <a href="#" class="share-btn" data-platform="Email" data-spot-id="@Model.SpotId">
                        <i class="fas fa-envelope"></i> Email
                    </a>
                    <a href="#" class="copy-link">
                        <i class="fas fa-link"></i> Sao ch√©p li√™n k·∫øt
                    </a>
                </div>
                <input type="hidden" name="__RequestVerificationToken" value="@Antiforgery.GetAndStoreTokens(Context).RequestToken" />
            </div>
        </div>
    </section>

    <!-- Spot Gallery -->
    <section class="spot-gallery">
        <div class="main-image">
            <img src="@Model.ImageUrl" alt="@Model.Name">
        </div>
        <div class="thumbnail-container">
            <div class="thumbnails">
                @if (Model.Images != null && Model.Images.Any())
                {
                    foreach (var image in Model.Images.Take(6))
                    {
                        <img src="@image.ImageUrl" alt="@Model.Name" onclick="changeMainImage(this.src)">
                    }
                }
                else
                {
                    <img src="@Model.ImageUrl" alt="@Model.Name" onclick="changeMainImage(this.src)">
                }
            </div>
            <button class="gallery-btn" id="viewAllPhotos">
                <i class="fas fa-images"></i> Xem t·∫•t c·∫£ ·∫£nh (@(Model.Images?.Count ?? 1))
            </button>
        </div>
    </section>

    <!-- Spot Details -->
    <div class="spot-content">
        <div class="spot-info">
            <section class="spot-description">
                <h2>Gi·ªõi thi·ªáu</h2>
                <p>@Model.Description</p>
            </section>

            <section class="spot-details-info">
                <h2>Th√¥ng tin chi ti·∫øt</h2>
                <div class="details-grid">
                    <div class="detail-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <div>
                            <h3>ƒê·ªãa ch·ªâ</h3>
                            <p>@Model.Address</p>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-clock"></i>
                        <div>
                            <h3>Th·ªùi gian tham quan l√Ω t∆∞·ªüng</h3>
                            <p>Th√°ng 2 - Th√°ng 5 v√† Th√°ng 9 - Th√°ng 10</p>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-calendar"></i>
                        <div>
                            <h3>Ng√†y t·∫°o</h3>
                            <p>@Model.CreatedAt.ToString("dd/MM/yyyy")</p>
                        </div>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-concierge-bell"></i>
                        <div>
                            <h3>D·ªãch v·ª•</h3>
                            <p>Resort, Kh√°ch s·∫°n, Nh√† h√†ng, Tour du l·ªãch, Th·ªÉ thao bi·ªÉn, Mua s·∫Øm</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="spot-map">
                <h2>B·∫£n ƒë·ªì</h2>
                <div class="map-container">
                    <iframe 
                        src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3724.0966890206833!2d105.78273807596354!3d21.02880648062325!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x3135ab4cd0c66f05%3A0xea31563511af2e54!2zSMOyIFTDonkgKEhvw6BuIEtp4bq_bSk!5e0!3m2!1svi!2s!4v1682956590065!5m2!1svi!2s" 
                        style="border:0;" 
                        allowfullscreen="" 
                        loading="lazy" 
                        referrerpolicy="no-referrer-when-downgrade">
                    </iframe>
                </div>
            </section>

            @if (Model.Images != null && Model.Images.Count > 6)
            {
                <section class="spot-gallery-extended">
                    <h2>B·ªô s∆∞u t·∫≠p h√¨nh ·∫£nh</h2>
                    <div class="gallery-grid">
                        @foreach (var image in Model.Images.Skip(6))
                        {
                            <div class="gallery-item">
                                <img src="@image.ImageUrl" alt="@Model.Name" onclick="openLightbox(this.src)">
                            </div>
                        }
                    </div>
                </section>
            }

            <section class="spot-videos">
                <h2>Video</h2>
                <div class="videos-container">
                    <div class="video-item">
                        <iframe width="560" height="315" src="https://www.youtube.com/embed/l2KxczkJdn8"
                            title="YouTube video player" frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen></iframe>
                        <p>Kh√°m ph√° v·∫ª ƒë·∫πp @Model.Name t·ª´ tr√™n cao</p>
                    </div>
                </div>
            </section>
        </div>

        <aside class="spot-sidebar">
            <div class="sidebar-widget weather-widget">
                <h3><i class="fas fa-cloud-sun"></i> Th·ªùi ti·∫øt</h3>
                <div class="weather-info">
                    <div class="current-weather">
                        <i class="fas fa-sun"></i>
                        <div>
                            <span class="temperature">30¬∞C</span>
                            <span class="condition">N·∫Øng</span>
                        </div>
                    </div>
                    <div class="forecast">
                        <div class="forecast-day">
                            <span>T2</span>
                            <i class="fas fa-cloud-sun"></i>
                            <span>29¬∞C</span>
                        </div>
                        <div class="forecast-day">
                            <span>T3</span>
                            <i class="fas fa-cloud"></i>
                            <span>28¬∞C</span>
                        </div>
                        <div class="forecast-day">
                            <span>T4</span>
                            <i class="fas fa-sun"></i>
                            <span>31¬∞C</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-widget">
                <h3><i class="fas fa-calendar-alt"></i> Th·ªùi ƒëi·ªÉm t·ªët nh·∫•t ƒë·ªÉ ƒë·∫øn</h3>
                <p>Th√°ng 2 ƒë·∫øn th√°ng 5 v√† th√°ng 9 ƒë·∫øn th√°ng 10 l√† th·ªùi ƒëi·ªÉm l√Ω t∆∞·ªüng ƒë·ªÉ thƒÉm @Model.Name v·ªõi th·ªùi ti·∫øt
                    d·ªÖ ch·ªãu, √≠t m∆∞a.</p>
            </div>

            <div class="sidebar-widget">
                <h3><i class="fas fa-info-circle"></i> M·∫πo du l·ªãch</h3>
                <ul class="tips-list">
                    <li>Thu√™ xe m√°y l√† c√°ch thu·∫≠n ti·ªán ƒë·ªÉ kh√°m ph√° khu v·ª±c</li>
                    <li>Mang theo kem ch·ªëng n·∫Øng v√† n√≥n khi ƒëi tham quan</li>
                    <li>Th·ª≠ c√°c m√≥n ƒë·∫∑c s·∫£n ƒë·ªãa ph∆∞∆°ng</li>
                    <li>Tham kh·∫£o th·ªùi ti·∫øt tr∆∞·ªõc khi ƒë·∫øn</li>
                </ul>
            </div>

            <div class="sidebar-widget">
                <h3><i class="fas fa-map-signs"></i> ƒê·ªãa ƒëi·ªÉm l√¢n c·∫≠n</h3>
                <ul class="nearby-places">
                    @{
                        // Gi·∫£ ƒë·ªãnh r·∫±ng b·∫°n c√≥ th·ªÉ truy c·∫≠p danh s√°ch ƒë·ªãa ƒëi·ªÉm l√¢n c·∫≠n t·ª´ ViewBag ho·∫∑c m·ªôt ngu·ªìn kh√°c
                        var nearbySpots = ViewBag.NearbySpots as List<TourismWeb.Models.TouristSpot> ?? new List<TourismWeb.Models.TouristSpot>();
                        
                        if (nearbySpots.Any())
                        {
                            foreach (var spot in nearbySpots)
                            {
                                <li class="nearby-places-item">
                                    <img src="@spot.ImageUrl" alt="@spot.Name">
                                    <div>
                                        <h4>@spot.Name</h4>
                                        <p>C√°ch spot.Distance km</p>
                                    </div>
                                </li>
                            }
                        }
                        else
                        {
                            <li class="nearby-places-item">
                                <img src="/images/phocohoian.jpg" alt="ƒê·ªãa ƒëi·ªÉm l√¢n c·∫≠n">
                                <div>
                                    <h4>ƒê·ªãa ƒëi·ªÉm l√¢n c·∫≠n</h4>
                                    <p>C√°ch 30km</p>
                                </div>
                            </li>
                        }
                    }
                </ul>
            </div>

            <div class="sidebar-widget">
                <h3><i class="fas fa-book-open"></i> C·∫©m nang du l·ªãch</h3>
                <ul class="travel-guide-list">
                    <li>
                        <a href="#">
                            <i class="fas fa-file-alt"></i>
                            <span>H∆∞·ªõng d·∫´n du l·ªãch @Model.Name t·ª´ A-Z</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <i class="fas fa-utensils"></i>
                            <span>Top 10 m√≥n ƒÉn ph·∫£i th·ª≠ ·ªü @Model.Name</span>
                        </a>
                    </li>
                    <li>
                        <a href="#">
                            <i class="fas fa-route"></i>
                            <span>L·ªãch tr√¨nh 3 ng√†y kh√°m ph√° @Model.Name</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="sidebar-widget">
                <h3><i class="fas fa-hiking"></i> Tr·∫£i nghi·ªám</h3>
                <div class="experiences-list">
                    @{
                        // Gi·∫£ ƒë·ªãnh r·∫±ng b·∫°n c√≥ th·ªÉ truy c·∫≠p danh s√°ch tr·∫£i nghi·ªám t·ª´ ViewBag ho·∫∑c m·ªôt ngu·ªìn kh√°c
                        var experiences = ViewBag.Experiences as List<dynamic> ?? new List<dynamic>();
                        
                        if (experiences.Any())
                        {
                            foreach (var exp in experiences)
                            {
                                <div class="experience-item">
                                    <img src="@exp.ImageUrl" alt="@exp.Title">
                                    <div class="experience-info">
                                        <h4>@exp.Title</h4>
                                        <div class="experience-meta">
                                            <span><i class="fas fa-star"></i> @exp.Rating</span>
                                            <span><i class="fas fa-clock"></i> @exp.Duration</span>
                                        </div>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="experience-item">
                                <img src="/images/bana.jpg" alt="Tr·∫£i nghi·ªám">
                                <div class="experience-info">
                                    <h4>Kh√°m ph√° @Model.Name</h4>
                                    <div class="experience-meta">
                                        <span><i class="fas fa-star"></i> 4.8</span>
                                        <span><i class="fas fa-clock"></i> 1 ng√†y</span>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                </div>
            </div>
        </aside>
    </div>

    <!-- Reviews Section -->
    <section class="reviews-section">
        <div class="section-header">
            <h2>ƒê√°nh gi√° (@(ViewBag.TotalReviews ?? 0))</h2>
            <div class="rating-summary">
                <div class="average-rating">
                    <span class="big-rating">@ViewBag.AverageRating</span>
                    <div class="stars">
                        @for (int i = 0; i < 5; i++)
                        {
                            if (i < ViewBag.AverageRating)
                            {
                                <i class="fas fa-star"></i> <!-- Sao ƒë·∫ßy -->
                            }
                            else if (i < ViewBag.AverageRating + 0.5)
                            {
                                <i class="fas fa-star-half-alt"></i> <!-- Sao n·ª≠a -->
                            }
                            else
                            {
                                <i class="far fa-star"></i> <!-- Sao r·ªóng -->
                            }
                        }
                    </div>
                    <span>@ViewBag.AverageRating/5</span> (@(ViewBag.TotalReviews ?? 0) ƒë√°nh gi√°)
                </div>

                <div class="rating-bars">
                    @for (int i = 0; i < 5; i++)
                    {
                        <div class="rating-bar">
                            <span>@(5 - i) sao</span>
                            <div class="bar-container">
                                <div class="bar" style="width: @(ViewBag.RatingPercentages[i] ?? 0)%"></div>
                            </div>
                            <span>@(ViewBag.RatingCounts[i] ?? 0)</span>
                        </div>
                    }
                </div>
            </div>
        </div>


        <div class="review-actions-bar">
            <button class="btn primary" id="writeReviewBtn"><i class="fas fa-pen"></i> Vi·∫øt ƒë√°nh gi√°</button>
            <!-- Form ƒë√°nh gi√°, m·∫∑c ƒë·ªãnh ·∫©n -->
    <div id="reviewForm" style="display:none;">
        <h3>Vi·∫øt ƒë√°nh gi√° cho ƒë·ªãa ƒëi·ªÉm</h3>

        <form asp-action="Create" asp-controller="Reviews" method="post" enctype="multipart/form-data">
            @Html.AntiForgeryToken()

            <!-- ƒêi·ªÅn SpotId v√†o form -->
            <input type="hidden" name="SpotId" value="@Model.SpotId" />

            <div class="form-group">
                <label>ƒê√°nh gi√°</label>
                <select name="Rating" class="form-control" required>
                    @for (int i = 5; i >= 1; i--)
                    {
                        <option value="@i">@i sao</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label>B√¨nh lu·∫≠n</label>
                <textarea name="Comment" class="form-control" required></textarea>
            </div>

            <div class="form-group">
                <label>·∫¢nh minh h·ªça (t√πy ch·ªçn)</label>
                <input type="file" name="imageFile" class="form-control" accept=".jpg,.jpeg,.png,.gif" />
            </div>

            <button type="submit" class="btn btn-primary">G·ª≠i ƒë√°nh gi√°</button>
        </form>
    </div>


            <div class="review-filters">
                <select id="sortReviews">
                    <option value="newest">M·ªõi nh·∫•t</option>
                    <option value="oldest">C≈© nh·∫•t</option>
                    <option value="highest">ƒêi·ªÉm cao nh·∫•t</option>
                    <option value="lowest">ƒêi·ªÉm th·∫•p nh·∫•t</option>
                </select>
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">T·∫•t c·∫£</button>
                    <button class="filter-btn" data-filter="5">5 sao</button>
                    <button class="filter-btn" data-filter="4">4 sao</button>
                    <button class="filter-btn" data-filter="3">3 sao</button>
                    <button class="filter-btn" data-filter="2">2 sao</button>
                    <button class="filter-btn" data-filter="1">1 sao</button>
                    <button class="filter-btn" data-filter="with-photos"><i class="fas fa-image"></i> C√≥ h√¨nh ·∫£nh</button>
                </div>
            </div>
        </div>

        <div class="reviews-list">
            @if (Model.Reviews != null && Model.Reviews.Any())
            {
                foreach (var review in Model.Reviews.Take(3))
                {
                    <div class="review-item">
                        <div class="review-user">
                            <img src="@review.User.AvatarUrl" alt="@review.User.FullName" class="user-avatar">
                            <div class="user-info">
                                <h4>@review.User.FullName</h4>
                                <p class="review-date">ƒê√£ ƒë√°nh gi√° v√†o @review.CreatedAt.ToString("dd/MM/yyyy")</p>
                            </div>
                        </div>
                        <div class="review-content">
                            <div class="review-rating">
                                <div class="stars">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        if (i <= review.Rating)
                                        {
                                            <i class="fas fa-star"></i>
                                        }
                                        else if (i - 0.5 <= review.Rating)
                                        {
                                            <i class="fas fa-star-half-alt"></i>
                                        }
                                        else
                                        {
                                            <i class="far fa-star"></i>
                                        }
                                    }
                                </div>
                            </div>
                            <p class="review-text">@review.Comment</p>
                            @if (review.ImageUrl != null && review.ImageUrl.Any())
                            {
                                <div class="review-photos">
                                    <img src="@review.ImageUrl" alt="·∫¢nh ƒë√°nh gi√°" onclick="openLightbox(this.src)">
                                </div>
                            }
                            <div class="review-actions">
                                <button class="like-btn"><i class="far fa-thumbs-up"></i> H·ªØu √≠ch (review.LikeCount)</button>
                                <button class="reply-btn"><i class="far fa-comment"></i> Ph·∫£n h·ªìi</button>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <!-- Sample review if no real reviews exist -->
                @* <div class="review-item">
                    <div class="review-user">
                        <img src="https://randomuser.me/api/portraits/women/42.jpg" alt="Ng∆∞·ªùi d√πng m·∫´u" class="user-avatar">
                        <div class="user-info">
                            <h4>Ng∆∞·ªùi d√πng m·∫´u</h4>
                            <p class="review-date">ƒê√£ ƒë√°nh gi√° v√†o 05/03/2023</p>
                        </div>
                    </div>
                    <div class="review-content">
                        <div class="review-rating">
                            <div class="stars">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                            </div>
                        </div>
                        <p class="review-text">@Model.Name th·ª±c s·ª± l√† m·ªôt ƒë·ªãa ƒëi·ªÉm tuy·ªát v·ªùi! T√¥i ƒë√£ c√≥ tr·∫£i nghi·ªám tuy·ªát v·ªùi v√† s·∫Ω quay l·∫°i trong t∆∞∆°ng lai.</p>
                        <div class="review-photos">
                            <img src="@Model.ImageUrl" alt="@Model.Name" onclick="openLightbox(this.src)">
                        </div>
                        <div class="review-actions">
                            <button class="like-btn"><i class="far fa-thumbs-up"></i> H·ªØu √≠ch (15)</button>
                            <button class="reply-btn"><i class="far fa-comment"></i> Ph·∫£n h·ªìi</button>
                        </div>
                    </div>
                </div> *@
            }

            @if ((Model.Reviews?.Count ?? 0) > 3)
            {
                <div class="load-more">
                    <button class="btn secondary" id="loadMoreReviews">Xem th√™m ƒë√°nh gi√°</button>
                </div>
            }
        </div>
    </section>

    <!-- Comments Section -->
    @* <section class="comments-section">
        <div class="section-header">
            <h2>B√¨nh lu·∫≠n (@(Model.Comments?.Count ?? 0))</h2>
        </div>

        <div class="add-comment">
            <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Your Avatar" class="user-avatar">
            <div class="comment-input-container">
                <textarea placeholder="Vi·∫øt b√¨nh lu·∫≠n c·ªßa b·∫°n..." id="commentInput"></textarea>
                <div class="comment-actions">
                    <button class="attach-btn"><i class="fas fa-image"></i></button>
                    <button class="attach-btn"><i class="fas fa-video"></i></button>
                    <button class="btn primary" id="postCommentBtn">ƒêƒÉng</button>
                </div>
            </div>
        </div>

        <div class="comments-list">
            @if (Model.Comments != null && Model.Comments.Any())
            {
                foreach (var comment in Model.Comments.Take(3))
                {
                    <div class="comment-item">
                        <img src="@comment.User.AvatarUrl" alt="@comment.User.FullName" class="user-avatar">
                        <div class="comment-content">
                            <div class="comment-header">
                                <h4>@comment.User.FullName</h4>
                                <span class="comment-date">@GetTimeAgo(comment.CreatedAt)</span>
                            </div>
                            <p>@comment.Content</p>
                            @if (!string.IsNullOrEmpty(comment.ImageUrl))
                            {
                                <div class="comment-media">
                                    <img src="@comment.ImageUrl" alt="H√¨nh ·∫£nh b√¨nh lu·∫≠n" onclick="openLightbox(this.src)">
                                </div>
                            }
                            <div class="comment-actions">
                                <button class="like-btn"><i class="far fa-thumbs-up"></i> Th√≠ch (comment.LikeCount)</button>
                                <button class="reply-btn"><i class="far fa-comment"></i> Ph·∫£n h·ªìi</button>
                            </div> *@

                            <!-- Replies -->
                            @* @if (comment.Replies != null && comment.Replies.Any())
                            {
                                <div class="comment-replies">
                                    @foreach (var reply in comment.Replies)
                                    {
                                        <div class="comment-item reply">
                                            <img src="@reply.User.AvatarUrl" alt="@reply.User.FullName" class="user-avatar">
                                            <div class="comment-content">
                                                <div class="comment-header">
                                                    <h4>@reply.User.FullName</h4>
                                                    <span class="comment-date">@GetTimeAgo(reply.CreatedAt)</span>
                                                </div>
                                                <p>@reply.Content</p>
                                                <div class="comment-actions">
                                                    <button class="like-btn"><i class="far fa-thumbs-up"></i> Th√≠ch (@reply.LikeCount)</button>
                                                    <button class="reply-btn"><i class="far fa-comment"></i> Ph·∫£n h·ªìi</button>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </div>
                            } *@
                        @* </div>
                    </div>
                }
            }
            else
            {
                <!-- Sample comment if no real comments exist -->
                <div class="comment-item">
                    <img src="https://randomuser.me/api/portraits/men/65.jpg" alt="Ng∆∞·ªùi d√πng m·∫´u" class="user-avatar">
                    <div class="comment-content">
                        <div class="comment-header">
                            <h4>Ng∆∞·ªùi d√πng m·∫´u</h4>
                            <span class="comment-date">3 ng√†y tr∆∞·ªõc</span>
                        </div>
                        <p>C√≥ ai bi·∫øt th·ªùi ƒëi·ªÉm n√†o t·ªët nh·∫•t ƒë·ªÉ ƒë·∫øn thƒÉm @Model.Name kh√¥ng ·∫°?</p>
                        <div class="comment-actions">
                            <button class="like-btn"><i class="far fa-thumbs-up"></i> Th√≠ch (5)</button>
                            <button class="reply-btn"><i class="far fa-comment"></i> Ph·∫£n h·ªìi</button>
                        </div>
                    </div>
                </div>
            }

            @if ((Model.Comments?.Count ?? 0) > 3)
            {
                <div class="load-more">
                    <button class="btn secondary" id="loadMoreComments">Xem th√™m b√¨nh lu·∫≠n</button>
                </div>
            }
        </div>
    </section> *@

    <!-- Action buttons -->
    <div class="action-buttons">
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Quay l·∫°i danh s√°ch
        </a>
        <div>
            <a asp-action="Edit" asp-route-id="@Model?.SpotId" class="btn btn-primary">
                <i class="fas fa-edit"></i> Ch·ªânh s·ª≠a
            </a>
            <a asp-action="Delete" asp-route-id="@Model?.SpotId" class="btn btn-danger">
                <i class="fas fa-trash-alt"></i> X√≥a
            </a>
        </div>
    </div>
</main>

<!-- Lightbox for images -->
<div id="lightbox" class="lightbox">
    <span class="close-lightbox">&times;</span>
    <img class="lightbox-content" id="lightbox-img">
    <div class="lightbox-caption"></div>
</div>

<!-- Token ƒë·ªÉ d√πng trong AJAX -->
<input type="hidden" name="__RequestVerificationToken" value="@Antiforgery.GetAndStoreTokens(Context).RequestToken" />

@section Scripts {
    <script>
        // Helper function for time ago display
        @functions {
            public string GetTimeAgo(DateTime dateTime)
            {
                TimeSpan timeDiff = DateTime.Now - dateTime;
                
                if (timeDiff.TotalDays > 30)
                    return dateTime.ToString("dd/MM/yyyy");
                if (timeDiff.TotalDays > 1)
                    return $"{(int)timeDiff.TotalDays} ng√†y tr∆∞·ªõc";
                if (timeDiff.TotalHours > 1)
                    return $"{(int)timeDiff.TotalHours} gi·ªù tr∆∞·ªõc";
                if (timeDiff.TotalMinutes > 1)
                    return $"{(int)timeDiff.TotalMinutes} ph√∫t tr∆∞·ªõc";
                
                return "V·ª´a xong";
            }
        }

        // Change main image when clicking on thumbnail
        function changeMainImage(src) {
            document.querySelector('.main-image img').src = src;
        }

        // Open lightbox when clicking on image
        function openLightbox(src) {
            document.getElementById('lightbox').style.display = 'flex';
            document.getElementById('lightbox-img').src = src;
        }

        // Close lightbox when clicking on X
        document.querySelector('.close-lightbox').addEventListener('click', function() {
            document.getElementById('lightbox').style.display = 'none';
        });

        // Toggle favorite button
        document.getElementById('favoriteBtn').addEventListener('click', function () {
            const btn = this;
            const spotId = btn.dataset.spotId;
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            fetch('/SpotFavorites/ToggleFavorite/' + spotId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('L·ªói khi c·∫≠p nh·∫≠t y√™u th√≠ch');
                return response.json();
            })
            .then(data => {
                if (data.favorited) {
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fas fa-heart"></i> ƒê√£ y√™u th√≠ch';
                } else {
                    btn.classList.remove('active');
                    btn.innerHTML = '<i class="far fa-heart"></i> Y√™u th√≠ch';
                }
            })
            .catch(err => alert(err));
        });

        // Show/hide share options
        document.querySelector('.share').addEventListener('click', function() {
            document.querySelector('.share-options').classList.toggle('show');
        });

        @* // Filter reviews
        document.querySelectorAll('.filter-btn').forEach(button => {
            button.addEventListener('click', function() {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                // Add filter logic here
            });
        }); *@
    </script>
    <script>
        document.querySelectorAll('.share-btn').forEach(btn => {
            btn.addEventListener('click', async function (e) {
                e.preventDefault();

                const platform = this.dataset.platform;
                const spotId = this.dataset.spotId;
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

                try {
                    const response = await fetch('/SpotShares/CreateFromShare', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify({ platform, spotId })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const urlToShare = data.url;

                        // M·ªü popup share theo platform
                        if (platform === "Facebook") {
                            window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(urlToShare)}`, '_blank');
                            // Th√¥ng b√°o c·∫£m ∆°n
                            alert("Thanks for sharing! üôå");    
                        } else if (platform === "Twitter") {
                            window.open(`https://twitter.com/intent/tweet?url=${encodeURIComponent(urlToShare)}&text=Check this out!`, '_blank');
                            alert("Thanks for sharing! üôå");
                        } else if (platform === "Email") {
                            window.open(`https://mail.google.com/mail/?view=cm&to=&su=Check this out&body=${encodeURIComponent(urlToShare)}`, '_blank');
                            alert("Thanks for sharing! üôå");
                        } else {
                            alert("This platform is not supported for direct sharing.");
                        }
                    } else {
                        alert("L·ªói khi chia s·∫ª. Vui l√≤ng th·ª≠ l·∫°i.");
                    }
                } catch (error) {
                    console.error(error);
                    alert("C√≥ l·ªói x·∫£y ra.");
                }    
            });
        });
    </script>
    <script>
        document.querySelector('.copy-link').addEventListener('click', function (e) {
            e.preventDefault();
            navigator.clipboard.writeText(window.location.href).then(function () {
                // Hi·ªÉn th·ªã toast
                const toast = document.getElementById('copy-toast');
                toast.style.display = 'block';

                // ·∫®n sau 2.5 gi√¢y
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 2500);

                // Ghi nh·∫≠n chia s·∫ª
                createShare("CopyLink");
            });
        });
    </script>
    @* <script>
        document.getElementById('writeReviewBtn').addEventListener('click', function() {
            var reviewForm = document.getElementById('reviewForm');
            reviewForm.style.display = (reviewForm.style.display === 'none' || reviewForm.style.display === '') ? 'block' : 'none';
        });
    </script> *@
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const reviewsListContainer = document.querySelector('.reviews-list');
            const loadMoreButton = document.getElementById('loadMoreReviews');
            const writeReviewBtn = document.getElementById('writeReviewBtn');
            const reviewForm = document.getElementById('reviewForm');
            const spotId = @Model.SpotId; // L·∫•y SpotId t·ª´ Model

            let currentPage = 1; // ƒê·ªÉ theo d√µi trang hi·ªán t·∫°i cho "Xem th√™m"
            const reviewsPerPage = 3; // S·ªë l∆∞·ª£ng review m·ªói l·∫ßn t·∫£i

            // H√†m ƒë·ªÉ t·∫£i v√† hi·ªÉn th·ªã reviews
            async function loadReviews(page = 1, sortBy = 'newest', filterByRating = 'all', filterByPhotos = false, append = false) {
                // V√¥ hi·ªáu h√≥a n√∫t "Xem th√™m" t·∫°m th·ªùi
                if (loadMoreButton) loadMoreButton.disabled = true;

                let url = `/TouristSpots/GetFilteredReviews?spotId=${spotId}&page=${page}&pageSize=${reviewsPerPage}&sortBy=${sortBy}&filterRating=${filterByRating}&withPhotos=${filterByPhotos}`;

                try {
                    const response = await fetch(url, {
                        method: 'GET',
                        headers: {
                            // N·∫øu c·∫ßn AntiForgeryToken cho GET (th∆∞·ªùng kh√¥ng c·∫ßn, nh∆∞ng n·∫øu server y√™u c·∫ßu)
                            // 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        }
                    });

                    if (!response.ok) {
                        console.error('L·ªói khi t·∫£i ƒë√°nh gi√°:', response.statusText);
                        // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói cho ng∆∞·ªùi d√πng n·∫øu c·∫ßn
                        if (loadMoreButton) loadMoreButton.disabled = false; // K√≠ch ho·∫°t l·∫°i n√∫t
                        return;
                    }

                    const htmlResult = await response.text();

                    if (append) {
                        // X√≥a n√∫t "Xem th√™m" c≈© tr∆∞·ªõc khi th√™m n·ªôi dung m·ªõi
                        const existingLoadMoreDiv = reviewsListContainer.querySelector('.load-more');
                        if (existingLoadMoreDiv) {
                            existingLoadMoreDiv.remove();
                        }
                        reviewsListContainer.insertAdjacentHTML('beforeend', htmlResult);
                    } else {
                        reviewsListContainer.innerHTML = htmlResult; // Thay th·∫ø to√†n b·ªô n·ªôi dung
                    }

                    currentPage = page;

                    // K√≠ch ho·∫°t l·∫°i n√∫t "Xem th√™m" n·∫øu c√≤n d·ªØ li·ªáu
                    const newLoadMoreButton = document.getElementById('loadMoreReviews'); // N√∫t c√≥ th·ªÉ ƒë√£ ƒë∆∞·ª£c render l·∫°i
                    if (newLoadMoreButton) {
                         // Logic ƒë·ªÉ ·∫©n/hi·ªán n√∫t "Xem th√™m" n√™n d·ª±a tr√™n vi·ªác server c√≥ tr·∫£ v·ªÅ n√∫t ƒë√≥ kh√¥ng,
                         // ho·∫∑c server tr·∫£ v·ªÅ m·ªôt c·ªù b√°o hi·ªáu c√≤n d·ªØ li·ªáu.
                         // V√≠ d·ª•, n·∫øu htmlResult kh√¥ng ch·ª©a class 'load-more', nghƒ©a l√† h·∫øt d·ªØ li·ªáu.
                         if (!htmlResult.includes('class="load-more"')) {
                            newLoadMoreButton.style.display = 'none';
                         } else {
                            newLoadMoreButton.style.display = 'block';
                            newLoadMoreButton.addEventListener('click', handleLoadMoreClick); // G·∫Øn l·∫°i event
                         }
                    }


                } catch (error) {
                    console.error('L·ªói fetch:', error);
                    if (loadMoreButton) loadMoreButton.disabled = false; // K√≠ch ho·∫°t l·∫°i n√∫t
                }
            }

            function getSelectedFilters() {
                const sortBy = document.getElementById('sortReviews').value;
                const activeRatingFilterBtn = document.querySelector('.filter-buttons .filter-btn.active');
                const filterByRating = activeRatingFilterBtn ? activeRatingFilterBtn.dataset.filter : 'all';
                const filterByPhotos = filterByRating === 'with-photos'; // N·∫øu n√∫t "C√≥ h√¨nh ·∫£nh" active
                // Ho·∫∑c n·∫øu b·∫°n c√≥ n√∫t "C√≥ h√¨nh ·∫£nh" ri√™ng bi·ªát:
                // const filterByPhotosBtn = document.querySelector('.filter-btn[data-filter="with-photos"]');
                // const filterByPhotos = filterByPhotosBtn ? filterByPhotosBtn.classList.contains('active') : false;

                return { sortBy, filterByRating: filterByPhotos ? 'all' : filterByRating, filterByPhotos };
            }

            // X·ª≠ l√Ω s·ª± ki·ªán cho c√°c n√∫t l·ªçc rating v√† n√∫t "C√≥ h√¨nh ·∫£nh"
            document.querySelectorAll('.filter-buttons .filter-btn').forEach(button => {
                button.addEventListener('click', function () {
                    document.querySelectorAll('.filter-buttons .filter-btn').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    currentPage = 1; // Reset v·ªÅ trang ƒë·∫ßu khi ƒë·ªïi filter
                    const filters = getSelectedFilters();
                    loadReviews(currentPage, filters.sortBy, filters.filterByRating, filters.filterByPhotos, false);
                });
            });

            // X·ª≠ l√Ω s·ª± ki·ªán cho dropdown s·∫Øp x·∫øp
            document.getElementById('sortReviews').addEventListener('change', function () {
                currentPage = 1; // Reset v·ªÅ trang ƒë·∫ßu khi ƒë·ªïi sort
                const filters = getSelectedFilters();
                loadReviews(currentPage, filters.sortBy, filters.filterByRating, filters.filterByPhotos, false);
            });

            // X·ª≠ l√Ω n√∫t "Xem th√™m"
            function handleLoadMoreClick() {
                const filters = getSelectedFilters();
                loadReviews(currentPage + 1, filters.sortBy, filters.filterByRating, filters.filterByPhotos, true);
            }

            if (loadMoreButton) {
                loadMoreButton.addEventListener('click', handleLoadMoreClick);
            }


            // N√∫t "Vi·∫øt ƒë√°nh gi√°"
            if (writeReviewBtn) {
                writeReviewBtn.addEventListener('click', function() {
                    reviewForm.style.display = (reviewForm.style.display === 'none' || reviewForm.style.display === '') ? 'block' : 'none';
                });
            }

            // T·∫£i review ban ƒë·∫ßu khi trang ƒë∆∞·ª£c load (n·∫øu b·∫°n kh√¥ng render s·∫µn)
            // Ho·∫∑c n·∫øu b·∫°n ƒë√£ render s·∫µn 3 review ƒë·∫ßu, th√¨ kh√¥ng c·∫ßn g·ªçi ·ªü ƒë√¢y tr·ª´ khi mu·ªën ƒë·ªìng b·ªô v·ªõi filter m·∫∑c ƒë·ªãnh.
            // const initialFilters = getSelectedFilters();
            // loadReviews(1, initialFilters.sortBy, initialFilters.filterByRating, initialFilters.filterByPhotos, false);

        });

        @* // H√†m m·ªü lightbox (gi·ªØ nguy√™n n·∫øu b·∫°n c√≥)
        function openLightbox(src) {
            // Logic m·ªü lightbox c·ªßa b·∫°n
            console.log('Open lightbox for:', src);
        } *@
    </script>
}

<div id="copy-toast" style="
    display: none;
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: #4CAF50;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    font-weight: bold;
    z-index: 9999;
    transition: opacity 0.3s ease;
">
    üîó ƒê√£ sao ch√©p li√™n k·∫øt!
</div>
